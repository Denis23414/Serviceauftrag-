create extension if not exists pgcrypto;
 
-- 1) Rollen
create table if not exists public.rolle (
  rolle_id smallint generated by default as identity primary key,
  rollen_name text not null unique
);
 
-- 2) Benutzer/Profile (verknÃ¼pft mit Supabase Auth)
create table if not exists public.benutzer (
  benutzer_id uuid primary key references auth.users(id) on delete cascade,
  vorname text not null,
  nachname text not null,
  rolle_id smallint not null references public.rolle(rolle_id),
  created_at timestamptz not null default now()
);
 
create index if not exists idx_benutzer_rolle_id on public.benutzer(rolle_id);
 
-- 3) Kunde
create table if not exists public.kunde (
  kunde_id bigint generated by default as identity primary key,
  typ text not null, -- z.B. 'Privat' | 'Firma'
  firmenname text,
  vorname text,
  nachname text,
  strasse text,
  plz text,
  ort text,
  telefon_privat text,
  telefon_geschaeft text,
  telefon_mobil text,
  email text,
  created_at timestamptz not null default now(),
  constraint chk_kunde_typ check (typ in ('Privat', 'Firma'))
);
 
-- 4) Auftragsstatus
create table if not exists public.auftragsstatus (
  status_id smallint generated by default as identity primary key,
  status_name text not null unique
);
 
-- 5) Auftrag
create table if not exists public.auftrag (
  auftrag_id bigint generated by default as identity primary key,
  auftragsnummer text not null unique,
  beschreibung text,
  objekt_adresse text,
  mieter_name text,
 
  erfasst_am timestamptz not null default now(),
  geplant_am timestamptz,
 
  kunde_id bigint not null references public.kunde(kunde_id),
  disponent_id uuid references public.benutzer(benutzer_id),
  monteur_id uuid references public.benutzer(benutzer_id),
 
  status_id smallint not null references public.auftragsstatus(status_id),
 
  constraint chk_geplant_am check (geplant_am is null or geplant_am >= erfasst_am)
);
 
create index if not exists idx_auftrag_kunde_id on public.auftrag(kunde_id);
create index if not exists idx_auftrag_status_id on public.auftrag(status_id);
create index if not exists idx_auftrag_disponent_id on public.auftrag(disponent_id);
create index if not exists idx_auftrag_monteur_id on public.auftrag(monteur_id);
 
-- 6) Rapport (1 Auftrag : n Rapporte)
create table if not exists public.rapport (
  rapport_id bigint generated by default as identity primary key,
  auftrag_id bigint not null references public.auftrag(auftrag_id) on delete cascade,
 
  arbeitsdatum date not null,
  startzeit time,
  endzeit time,
 
  arbeitsbeschreibung text,
 
  erledigt boolean not null default false,
  pausen_min integer not null default 0,
  muss_nochmal boolean not null default false,
 
  unterschrift text, -- z.B. Base64; alternativ Storage verwenden
 
  created_at timestamptz not null default now(),
 
  constraint chk_rapport_zeiten check (
    startzeit is null or endzeit is null or endzeit >= startzeit
  ),
  constraint chk_pausen_min check (pausen_min >= 0)
);
 
create index if not exists idx_rapport_auftrag_id on public.rapport(auftrag_id);
 
-- 7) Material
create table if not exists public.material (
  material_id bigint generated by default as identity primary key,
  artikelnummer text not null unique,
  bezeichnung text not null,
  einheit text not null, -- z.B. 'Stk', 'm', 'h'
  einzelpreis numeric(10,2) not null default 0
);
 
-- 8) Rapportposition (Materialverbrauch)
create table if not exists public.rapportposition (
  position_id bigint generated by default as identity primary key,
  rapport_id bigint not null references public.rapport(rapport_id) on delete cascade,
  material_id bigint not null references public.material(material_id),
  menge numeric(10,2) not null default 1,
  einzelpreis_snapshot numeric(10,2) not null default 0,
 
  constraint chk_menge check (menge > 0),
  constraint chk_einzelpreis_snapshot check (einzelpreis_snapshot >= 0)
);
 
create index if not exists idx_rapportposition_rapport_id on public.rapportposition(rapport_id);
create index if not exists idx_rapportposition_material_id on public.rapportposition(material_id);
 
-- Seed-Daten (optional)
insert into public.rolle (rollen_name)
values ('ADMIN'), ('BL'), ('MA')
on conflict do nothing;
 
insert into public.auftragsstatus (status_name)
values ('NEU'), ('DISPONIERT'), ('AUSGEFUEHRT'), ('FREIGEGEBEN'), ('VERRECHNET')
on conflict do nothing;
